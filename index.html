<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Privacy Benchmark</title>
    <meta name="description" content="Check sites for data privacy and security">
    <meta name="author" content="Kolmogorov's gang">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">
    <div class="header">
        <div class="logo"><b>PRIVACY</b>BENCHMARK</div>
    </div>
    <div class="description">
        <h1 class="siteDescription">
            Is your website private enough?
        </h1>
        <span class="shadowedText">
            Enter website url to check if this site sends your data to 3rd parties. Information is presented as a char to compare your site with others
        </span>
        <div class="search">
            <input type="text" placeholder="URL, e.g. google.com" id="checkInput">
            <button onclick="check()" id="checkBtn">Check!</button>
            <div id="loader" class="loader"></div>
        </div>
    </div>
    <div class="chart">
        <div id="chartFloatWindow">
            <img src="" id="chartImg">
            <span id="chartText"></span>
        </div>
        <svg width="960" height="300" id="chartSvg"></svg>
    </div>
</div>

<script src="./d3.v4.min.js"></script>
<script>
    let data = []
    let newSiteData = []
    loadMainData().then(response => {
        return response.json()
    })
        .then(resultResponse => {
            loadImagesIntoCash(resultResponse)
            const X = []
            for (let key in resultResponse) {
                if (resultResponse.hasOwnProperty(key)) {
                    X.push([resultResponse[key].score, key])
                }
            }
            let yValue = 0.8
            let length = X.length
            for (let i = 0; i < length; i++) {
                data.push([20 + X[i][0], yValue * Math.random() + 0.01, X[i][1]])
            }

            console.log('data:', data)

            firstRender()
        })
        .catch(error => {
            console.log('Error in resultResponse:', error)
        })


    function check() {
        let url = document.getElementById('checkInput').value
        loadWebsiteData(url)
    }

    function loadMainData() {
        return fetch('/data', {method: 'get'})
    }

    function loadWebsiteData(url) {
        document.getElementById('loader').style.opacity = '1'
        fetch('/website?hostname=' + encodeURI(url), {method: 'get'})
            .then(response => {
                return response.json()
            })
            .then(result => {
                let yValue = 0.8
                newSiteData = [20 + result.score, yValue * Math.random() + 0.01, url]
                firstRender(true)
            })
            .catch(error => {
                console.log("ERROR:", error)
                console.error(url)
            })
            .finally(() => {
                document.getElementById('loader').style.opacity = '0'
            })
    }

    function loadImagesIntoCash(objectOfUrls) {
        Object.keys(objectOfUrls).forEach(url => {
            let img = document.createElement('img')
            img.src = 'http://' + url + '/favicon.ico'
        })
    }


    function firstRender(add = false) {
        // if (removeOld) d3.select("svg").selectAll("*").remove()
        const svg = d3.select("#chartSvg")
        const margin = {top: 50, right: 10, bottom: 100, left: 10}
        const width = +svg.attr("width") - margin.left - margin.right
        const height = +svg.attr("height") - margin.top - margin.bottom

        const g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        const x = d3.scaleLinear()
            .domain([-0.5, 20])
            .range([0, width])

        const y = d3.scaleLinear()
            .range([height, 0])

        svg.append("text")
            .attr("transform",
                "translate(" + 25 + " ," +
                (height + margin.top + 50) + ")")
            .style("text-anchor", "middle")
            .style('fill', '#ff0000')
            .style('font-weight', 'bold')
            .text("Worst")
        svg.append("text")
            .attr("transform",
                "translate(" + width + " ," +
                (height + margin.top + 50) + ")")
            .style("text-anchor", "middle")
            .style('fill', '#5DCD32')
            .style('font-weight', 'bold')
            .text("Best")
        if (!add) {
            const dot = g.append("g")
                .attr("fill-opacity", 0.5)
                //.style('fill', 'url(#svgGradient)')
                .selectAll("circle")
                .data(data)
                .enter().append("circle")
                .style('fill', 'red')
                .attr("transform", function (d) {
                    return "translate(" + x(d[0]) + "," + y(d[1]) + ")"
                })
                .attr("r", 5)
                .on("mouseleave", function (d) {
                    document.getElementById("chartText").innerHTML = ""
                    document.getElementById("chartImg").style.opacity = "0"
                    d3.select(this).attr("r", 5)
                })
                .on("mouseover", function (d) {
                    document.getElementById("chartText").innerHTML = d[2] + ', ' + Math.round(d[0] * 100) / 100
                    document.getElementById("chartImg").style.opacity = "1"
                    document.getElementById("chartImg").src = 'http://' + d[2] + '/favicon.ico'
                    d3.select(this).attr("r", 10)
                })

            g.append("g")
                .attr("class", "axisWhite")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).ticks(20))
        } else {
            const dot = g.append("g")
                .attr("fill-opacity", 0.9)
                .style("fill", 'white')
                .selectAll("circle")
                .data([newSiteData])
                .enter().append("circle")
                .attr("transform", function (d) {
                    return "translate(" + x(d[0]) + "," + y(d[1]) + ")"
                })
                .attr("r", 5)
                .on("mouseleave", function (d) {
                    document.getElementById("chartText").innerHTML = ""
                    document.getElementById("chartImg").style.opacity = "0"
                    d3.select(this).attr("r", 5).style("fill", 'white')
                })
                .on("mouseover", function (d) {
                    document.getElementById("chartText").innerHTML = d[2] + ', ' + Math.round(d[0] * 100) / 100
                    document.getElementById("chartImg").style.opacity = "1"
                    document.getElementById("chartImg").src = 'http://' + d[2] + '/favicon.ico'
                    d3.select(this).attr("r", 10).style("fill", 'white')
                })
        }
    }

    // Send by click enter
    let input = document.getElementById("checkInput")
    input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault()
            document.getElementById("checkBtn").click()
        }
    })
</script>

</body>
</html>