<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Staty</title>
    <meta name="description" content="Check sites for data privacy and security">
    <meta name="author" content="Kolmogorov's gang">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">
    <div class="header">
        <div class="logo"><b>PRIVACY</b>BENCHMARK</div>
    </div>
    <div class="description">
        <h1 class="siteDescription">
            Is your website private enough?
        </h1>
        <span class="shadowedText">
            Enter website url to check if this site sends your data to 3rd parties. Information is presented as a char to compare your site with others
        </span>
        <div class="search">
            <input type="text" placeholder="URL, e.g. google.com" id="checkInput">
            <button onclick="check()">Check!</button>
        </div>
    </div>
    <div class="chart">
        <div id="chartFloatWindow">
            <img src="" id="chartImg">
            <span id="chartText"></span>
        </div>
        <svg width="960" height="300" id="chartSvg"></svg>
    </div>
</div>
<script>

    function loadMainData() {
        return fetch('/data', {method: 'get'})
    }

    function loadWebsiteData(url) {
        fetch('/website?hostname=' + encodeURI(url), {method: 'get'})
            .then(response => {
                console.log(response)
            })
            .catch(error => {
                console.log("ERROR");
                console.error(url)
            })
    }
</script>
<script src="./d3.v4.min.js"></script>
<script>
    let data = [];
    loadMainData().then(response => {
        return response.json()
    })
        .then(resultResponse => {
            const X = [];
            for (let key in resultResponse) {
                if (resultResponse.hasOwnProperty(key)) {
                    X.push([resultResponse[key].score, key])
                }

            }
            let yValue = 0.8;
            let length = X.length;
            for (let i = 0; i < length; i++) {
                data.push([-1 * X[i][0] + Math.random(), yValue * Math.random() + 0.01, X[i][1]])
            }

            preRender()
        })
        .catch(error => {
            console.log('Error in resultResponse:', error)
        });


    function check() {
        let url = document.getElementById('checkInput').value;
        loadWebsiteData(url)
    }

    function addSite(site) {
        data.push([site.x, site.y])
    }

    function preRender() {

        const svg = d3.select("svg");
        const margin = {top: 50, right: 10, bottom: 100, left: 10};
        const width = +svg.attr("width") - margin.left - margin.right;
        const height = +svg.attr("height") - margin.top - margin.bottom;

        const g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const x = d3.scaleLinear()
            .domain([-0.5, 20])
            .range([0, width]);

        const y = d3.scaleLinear()
            .range([height, 0]);

        const dot = g.append("g")
            .attr("fill-opacity", 0.5)
            .style("fill", "red")
            .selectAll("circle")
            .data(data)
            .enter().append("circle")
            .attr("transform", function (d) {
                return "translate(" + x(d[0]) + "," + y(d[1]) + ")"
            })
            .attr("r", 5)
            .on("mouseleave", function (d) {
                document.getElementById("chartText").innerHTML = "";
                document.getElementById("chartImg").style.opacity = "0";
                d3.select(this).attr("r", 5).style("fill", "red")
            })
            .on("mouseover", function (d) {
                document.getElementById("chartText").innerHTML = d[2] + ', ' + Math.round(d[0] * 100) / 100;
                document.getElementById("chartImg").style.opacity = "1";
                document.getElementById("chartImg").src = 'http://' + d[2] + '/favicon.ico';
                d3.select(this).attr("r", 10).style("fill", "red")
            });

        g.append("g")
            .attr("class", "axisWhite")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(20))
    }
</script>

</body>
</html>